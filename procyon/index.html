<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Procyon Sector Navigation Console</title>
    <script src="https://unpkg.com/panzoom@9.4.0/dist/panzoom.min.js"></script>
    <link rel="stylesheet" href="src/css/styles.css">
</head>
<body>
    <div class="console-frame">
        <div class="corner corner-tl"></div>
        <div class="corner corner-tr"></div>
        <div class="corner corner-bl"></div>
        <div class="corner corner-br"></div>
        
        <div class="console-header">
            <div class="console-title"><h1>Procyon Sector Navigation</h1></div>
            <div class="console-status">SYSTEM READY</div>
        </div>
        
        <div class="console-content">
            <div class="scan-line"></div>
            <div class="map-container" id="map-container">
                <!-- SVG will be loaded here -->
            </div>
        </div>
    </div>

    <a href="about.html" class="about-link">About</a>

    <!-- Modal Structure -->
    <div class="modal-overlay" id="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="modal-title"></div>
                <button class="modal-close" id="modal-close">&times;</button>
            </div>
            <div class="modal-content" id="modal-content"></div>
        </div>
    </div>

    <script>
        // Wait for panzoom to be available
        window.addEventListener('load', function() {
            let objectsData = null;
            const modalOverlay = document.getElementById('modal-overlay');
            const modalTitle = document.getElementById('modal-title');
            const modalContent = document.getElementById('modal-content');
            const modalClose = document.getElementById('modal-close');

            // Load the objects data
            fetch('assets/data/objects.json')
                .then(response => response.json())
                .then(data => {
                    objectsData = data;
                });

            // Function to show modal with object data
            function showObjectData(id) {
                if (!objectsData || !objectsData[id]) return;
                
                const object = objectsData[id];
                modalTitle.textContent = object.name;
                
                let content = `<p>${object.description}</p>`;
                
                if (object.type === 'system' && object.notable_places) {
                    content += '<h3>Notable Places</h3>';
                    for (const [placeId, place] of Object.entries(object.notable_places)) {
                        content += `<p><strong>${place.name}:</strong> ${place.description}</p>`;
                    }
                }
                
                if (object.notables) {
                    content += '<h3>Notable Figures</h3>';
                    for (const [notableId, notable] of Object.entries(object.notables)) {
                        content += `<p><strong>${notable.name}:</strong> ${notable.description}</p>`;
                    }
                }
                
                modalContent.innerHTML = content;
                modalOverlay.classList.add('active');
            }

            // Close modal when clicking close button
            modalClose.addEventListener('click', () => {
                modalOverlay.classList.remove('active');
            });

            // Close modal when clicking outside
            modalOverlay.addEventListener('click', (e) => {
                if (e.target === modalOverlay) {
                    modalOverlay.classList.remove('active');
                }
            });

            // Close modal when pressing escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && modalOverlay.classList.contains('active')) {
                    modalOverlay.classList.remove('active');
                }
            });

            // Load the SVG file
            fetch('assets/images/procyon-sector-map.svg')
                .then(response => response.text())
                .then(svgText => {
                    const mapContainer = document.getElementById('map-container');
                    mapContainer.innerHTML = svgText;
                    
                    // Get the SVG element
                    const svg = mapContainer.querySelector('svg');
                    
                    // Calculate the initial scale to fill the container
                    const bbox = svg.getBBox();
                    const containerWidth = mapContainer.clientWidth;
                    const containerHeight = mapContainer.clientHeight;
                    
                    // Calculate scale to fill the container while maintaining aspect ratio
                    const scaleX = containerWidth / bbox.width;
                    const scaleY = containerHeight / bbox.height;
                    const initialScale = Math.max(scaleX, scaleY) * 1.1; // Add 10% padding
                    
                    // Initialize panzoom with bounds
                    const instance = panzoom(svg, {
                        maxZoom: 8,
                        minZoom: initialScale, // Prevent zooming out beyond initial scale
                        bounds: true,
                        boundsPadding: 0.1,
                        zoomDoubleClickSpeed: 1,
                        smoothScroll: false,
                        zoomDoubleClick: true, // Enable double-click to zoom
                        zoomDoubleClickSpeed: 1.5 // Zoom factor for double-click
                    });

                    // Handle touch events
                    mapContainer.addEventListener('touchstart', instance.handleTouchStart);
                    mapContainer.addEventListener('touchmove', instance.handleTouchMove);
                    mapContainer.addEventListener('touchend', instance.handleTouchEnd);

                    // Handle mouse events
                    mapContainer.addEventListener('wheel', instance.zoomWithWheel);

                    // Add click handlers to interactive regions
                    svg.querySelectorAll('rect[id]').forEach(rect => {
                        // Make the rect fill the entire area
                        rect.style.fill = 'rgba(255, 255, 0, 0.1)';
                        rect.style.cursor = 'pointer';
                        
                        // Add click handler
                        rect.addEventListener('click', function(event) {
                            const id = this.getAttribute('id');
                            showObjectData(id);
                            // Prevent zoom on click
                            event.stopPropagation();
                        });

                        // Add touch handler for mobile
                        rect.addEventListener('touchend', function(event) {
                            const id = this.getAttribute('id');
                            showObjectData(id);
                            // Prevent zoom on touch
                            event.stopPropagation();
                        });
                    });

                    // Center the map
                    const centerX = (containerWidth - bbox.width * initialScale) / 2;
                    const centerY = (containerHeight - bbox.height * initialScale) / 2;
                    
                    // Set initial transform
                    instance.transform({
                        scale: initialScale,
                        x: centerX,
                        y: centerY
                    });
                });
        });
    </script>
</body>
</html>
